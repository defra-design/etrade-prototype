<!-- This is dynamicaly generated by the array in /app/data/certs.json -->
{% if cert.species | length == 0 %}
  {% set listOfSpecies = cert.commodities[commodityID].species %}
{% else %}
  {% set listOfSpecies = cert.species %}
{% endif %}

{% if field.multiple =="yes" %}
  {% if query.change  %}
  <!-- This is a string -->
    {% if identification.species is string %}
      {% set initialSavedValue = identification.species %}
    {% else %}
      <!-- This is an array -->
      {% set initialSavedValue = identification.species[0] %}
    {% endif  %}
  {% endif  %}
<div class="govuk-form-group app-repeadable-holder" id="repeatable-species-holder">
  <label class="govuk-label" for="TAXON">Species {% if field.required == "no" %}&nbsp;(optional for <abbr title="TRACES is the EU's digital certification platform. You can submit your application without entering this information.">TRACES</abbr>){% endif %}</label>
  <div class="app-repeatable-section" id="repeatable-species">
    <div class="govuk-input__wrapper ">
      <select class="govuk-select govuk-!-width-two-thirds" id="TAXON" name="species">
        <option disabled="" value="" {% if not (species) %}selected{%endif%}>{% if (listOfSpecies| length) <= 50%}Select a taxonomy{% endif %}</option>
        {% for species in listOfSpecies%}
        <option value="{{species}}" {% if (query.change ) and (species == identification.species[0]) %}selected{% elseif (query.updated == 'yes' or query.hasError == 'yes') and data.species == species %}selected{%endif%}>{{species}}</option>
        {% endfor %}]
      </select>

      <div class="govuk-input__suffix suffix__action no-border" aria-hidden="true">
        <button type="button" data-count="1" data-target="repeatable-species" class="govuk-button govuk-button--secondary multi-data add-repeatable-section"><span class="fas fa-plus"></span></button>
      </div>
    </div>
  </div>
  <!-- if this is change or copy and there are multiple rows -->

  {% if not identification.species is string and (query.change)%}
  {% for row in identification.species%}

  <!-- Dont need to show the 1st one which is the main control above -->
  {% if loop.index > 1%}
  <div class="app-repeatable-section govuk-!-margin-top-2" id="repeatable-species{{loop.index}}">
    <div class="govuk-input__wrapper ">
      
      <select class="govuk-select govuk-!-width-two-thirds" id="TAXON" name="species">
        <option disabled="" value="" {% if not (query.change ) %}selected{%endif%}>{% if (listOfSpecies| length) <= 50%}Select a taxonomy{% endif %}</option>
        {% for species in listOfSpecies%}
        <option value="{{row}}" {% if (query.change) and (row == identification.species[loop.index-1]) %}selected{% elseif (query.updated == 'yes' or query.hasError == 'yes') and data.species == species %}selected{%endif%}>{{row}}</option>
        {% endfor %}]
      </select>

      <div class="govuk-input__suffix suffix__action no-border" aria-hidden="true">
        <button data-target="repeatable-species{{loop.index}}" class="govuk-button delete-button govuk-button--secondary"><span class="fas fa-trash-alt"></span></button>
      </div>
    </div>
  </div>

  {% endif %}
  {% endfor %}
  {% endif %}
</div>
<input type="hidden" value="{{initialSavedValue}}" name="defaultValue" id="defaultValue">
{% else %}
<div class="govuk-form-group">
  <label class="govuk-label" for="TAXON">Species {% if field.required == "no" %}&nbsp;(optional for <abbr title="TRACES is the EU's digital certification platform. You can submit your application without entering this information.">TRACES</abbr>){% endif %}</label>

  <select class="govuk-select govuk-!-width-two-thirds" id="TAXON" name="species">
    <option disabled="" value="" {% if not (identification.species) %}selected{%endif%}>{% if (listOfSpecies| length) <= 10%}Select a taxonomy{% endif %}</option>
    {% if (listOfSpecies| length) > 0%}
    {% for species in listOfSpecies%}
    <option value="{{species}}" {% if (query.change ) and (species == identification.species) %}selected{% elseif (query.updated == 'yes' or query.hasError == 'yes') and data.species == species %}selected{%endif%}>{{species}}</option>
    {% endfor %}]
    {% else %}
    <option value="not set">Not set any species in JSON</option>
    {% endif %}
  </select>
  <input type="hidden" value="{% if query.change  %}{{identification.species}}{%endif%}" name="defaultValue" id="defaultValue">
</div>
{% endif %}


{% if (listOfSpecies| length) > 50 %}
<script type="text/javascript" src="/public/javascripts/accessible-autocomplete.min.js"></script>
<script type="text/javascript">
  window.addEventListener('load', function() {
    id = 'autocomplete-autoselect';
    element = document.querySelector('#TAXON')
    accessibleAutocomplete.enhanceSelectElement({
      selectElement: element,
      showAllValues: true,
      dropdownArrow: () => '',
      autoselect: false,
      defaultValue: document.querySelector("#defaultValue").value || ''
    })
    // accessibleAutocomplete.enhanceSelectElement({
    //   selectElement: element,
    //   name : "species",
    //   showAllValues: true,
    //   autoselect: false,
    //   defaultValue: document.querySelector("#defaultValue").value || ''
    // })
    // If you want a chevron dropdown:

    // dropdownArrow: function (config) {
    //   return '<svg class="autocomplete__dropdown-arrow-down" style="top: 12px;" viewBox="0 0 512 512" ><path d="M256,298.3L256,298.3L256,298.3l174.2-167.2c4.3-5.2,11.4-4.1,15.8,0.2l30.6,29.9c4.4,4.3,4.5,11.3,0.2,15.5L264.1,380.9  c-2.2,2.2-5.2,3.2-8.1,3c-3,0.1-5.9-0.9-8.1-3L35.2,176.7c-4.3-5.2-4.2-11.2,0.2-15.5L66,131.3c4.4-4.3,11.5-4.4,15.8-0.2L256,298.3  z"/></svg>'
    // },
  })
</script>
{% endif %}
